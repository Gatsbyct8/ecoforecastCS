#!/usr/bin/python
import cgi
import cgitb; cgitb.enable()
import time
import Cookie
import os
import string
import random
from print_pages import *
from do_mongo import *
from do_whisk import *



def set_cookie(email, work_dir):
	cookie = Cookie.SimpleCookie()
	cookie["remember_me"] = work_dir
	cookie["email"] = email
	print cookie

def do_authenticate(form):
	email = form["email"].value
	#check from database
	work_dir = mongo_do_authenticate(email)
	set_cookie(email, work_dir)

	return True

def create_job(form, cookie):

	user_dir = cookie["remember_me"].value

	r_code = form["r_code"].value
	transaction_dir = ''.join(random.choice(string.ascii_uppercase + string.digits) for _ in range(10))
	os.system("mkdir users/" +user_dir+"/"+transaction_dir)

	git_libs = form["job_git_libs"].value
	cran_libs = form["job_cran_libs"].value
	fileitem = form['file']
	repeat_interval = -1

	end_date = form["end_date"].value
	model_name = form["model_name"].value

	if fileitem.filename != "":
		#show_error_page(form)
		fn = os.path.basename(fileitem.filename)
		f = open("users/"+user_dir+"/"+ transaction_dir+"/supportingfiles.zip", 'wb')
		f.write(fileitem.file.read())
		f.close()
	#print_header()

	if "repeat_it" in form and form["repeat_it"].value == "Yes":
		repeat_interval = int(float(form["run_interval"].value)*60)

	try:
		#date format: 2018-08-16, year-mon-day
		openwhisk_exec(model_name, user_dir, transaction_dir, r_code, "users/"+user_dir+"/"+transaction_dir, cran_libs, git_libs, repeat_interval, end_date )
	except:
		pass

	return True

	print "Model Name: " + model_name
	print "<br>Transaction Folder: "
	print "<br>users/"+user_dir+"/"+ transaction_dir
	print "<br>Git Libs :" + git_libs 
	print "<br>Cran Libs :" + cran_libs 
	print "<br>Interval: " + str(repeat_interval)
	print "<br>End date: " + str(end_date)


def show_logs(user_id):
	rec = mongo_get_results(user_id)
	show_all_record_page(rec, "redirect")

def view_one_result(user_id, transaction_id):
	res = mongo_get_one_result(user_id, transaction_id)
	f = open("users/"+user_id+"/view_results/view.json", "wb")
	f.write(res)
	f.close()
	show_one_result(user_id)


def take_to(url):
	print_header()
	print """ <meta http-equiv="refresh" content="0; url={0}" /> """.format(url)
if __name__=="__main__":
	cookie = Cookie.SimpleCookie()
	try:
		cs = os.environ["HTTP_COOKIE"]
		#create cookie object
		cookie.load(cs)
	except:
		pass
	# get form fields
	form = cgi.FieldStorage()
	if "remember_me" in cookie:
		user_id = cookie["remember_me"].value
		if "new_exp" in form:
			show_lib_page()

		elif "show_old" in form:
			rec = mongo_get_results(user_id)
			show_all_record_page(rec, "user-clikc")

		elif "code_libs" in form:
			cran_libs = ""
			git_libs = ""
			if "cran_libs" in form:
				cran_libs = form["cran_libs"].value
			if "git_libs" in form:
				git_libs = form["git_libs"].value
			show_submit_code_page(cran_libs, git_libs)

		elif "submit_job" in form:
			if form["r_code"].value != "":
				#print_header()
				if create_job(form, cookie):
					take_to("?show_old=clicked&user_id="+str(user_id))
			else:
				show_error_page("Ever consider submitting code?")
		elif "show_one_result" in form and "user_id" in form and "transaction_id" in form:
			view_one_result(form["user_id"].value, form["transaction_id"].value)
		else:
			show_home_page()



	elif "login_button" in form:
		if do_authenticate(form):
			show_home_page()

	else:
		show_login_page()
